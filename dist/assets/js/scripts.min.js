"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}var Asteroid=function(){function t(e,i,s){_classCallCheck(this,t),this.sprite=e.spriteAsteroid,this.active=!0,this.x=i,this.y=s,this.scale=Math.round(120*Math.random()),this.scale=this.scale<30?this.scale=30:this.scale,this.angle=30,this.speed=Math.max(2,8*Math.random()),this.c=e.context,this.main=e}return _createClass(t,[{key:"draw",value:function(){this.c.drawImage(this.sprite,this.x,this.y,this.scale,this.scale)}},{key:"update",value:function(){this.x-=this.speed,this.active=this.active&&this.inBounds()}},{key:"inBounds",value:function(){return this.x>=-120&&this.x<=this.main.getWidth()}},{key:"resize",value:function(){}}]),t}(),Bullet=function(){function t(e,i,s){_classCallCheck(this,t),this.width=10,this.height=2,this.active=!0,this.x=i,this.y=s,this.main=e}return _createClass(t,[{key:"draw",value:function(){this.main.context.fillStyle="cyan",this.main.context.fillRect(this.x,this.y,this.width,this.height)}},{key:"inBounds",value:function(){return this.x>=0&&this.x<=this.main.getWidth()}},{key:"update",value:function(){this.x+=15,this.active=this.active&&this.inBounds()}}]),t}(),GameTeste=function(){this.fps=60,this.canvas,this.context,this.pointers=[],this.joystick=1,this.devicePixelRatio=1,this.backingStoreRatio=1,this.ratio=1,this.half={},this.leftPointerID=-1,this.ship=new SpaceShip,this.leftPointerPos=new Vector2(0,0),this.leftPointerStartPos=new Vector2(0,0),this.leftVector=new Vector2(0,0),this.firebtn,this.joystickbtn,this.stars=new Starfield,this.score=new Score(0),this.asteroids=[],this.lastTime=Date.now(),this.gameTime=1e-4,this.fase=1,this.endTime=Date.now()+3e4,this.isGameOver=!1,this.sounds=!1,this.life=3,this.stats=new Stats,this.spriteAsteroid,this.audioPath="assets/sounds/",this.manifest=[{id:"shot",src:"shot.ogg"},{id:"explosion",src:"explosion.ogg"},{id:"musicfx",src:"musicfx.ogg"}];var t=this.keycodes={32:"space",87:"up",83:"down"},e=(this.keystatus={},this.mute=!0,this.self=this);this.setPixelRatio=function(){if(this.devicePixelRatio=window.devicePixelRatio||1,this.backingStoreRatio=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1,this.ratio=this.devicePixelRatio/this.backingStoreRatio,this.devicePixelRatio!==this.backingStoreRatio){var t=this.canvas.width,e=this.canvas.height;this.canvas.width=t*this.ratio,this.canvas.height=e*this.ratio,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.context.scale(this.ratio,this.ratio)}else this.canvas.width=this.getWidth(),this.canvas.height=this.getHeight()},this.createFireButton=function(){this.context.drawImage(this.firebtn,0,0,this.firebtn.width,this.firebtn.height,this.getWidth()-110,this.getHeight()-110,80,80)},this.createJoystickButton=function(t,e){this.context.beginPath(),this.context.lineWidth=2,this.context.arc(this.leftPointerStartPos.x,this.leftPointerStartPos.y,25,0,2*Math.PI,!0),this.context.stroke(),this.context.strokeStyle="rgba(255,255,255,0.4)",this.context.fillStyle="rgba(255,255,255,0.3)",this.context.fill(),this.context.beginPath(),this.context.lineWidth=1,this.context.arc(this.leftPointerStartPos.x,this.leftPointerStartPos.y,48,0,2*Math.PI,!0),this.context.stroke(),this.context.strokeStyle="rgba(255,255,255,0.4)",this.context.fillStyle="rgba(255,255,255,0.1)",this.context.fill(),this.context.beginPath(),this.context.lineWidth=1,this.context.arc(this.leftPointerStartPos.x,this.leftPointerStartPos.y,50,0,2*Math.PI,!0),this.context.stroke(),this.context.strokeStyle="rgba(255,255,255,0.4)",this.context.fillStyle="rgba(255,255,255,0.1)",this.context.fill(),this.context.drawImage(this.joystickbtn,0,0,this.joystickbtn.width,this.joystickbtn.height,t-30,e-30,60,60)},this.setControlPos=function(t){this.leftPointerStartPos.x=70,this.leftPointerStartPos.y=this.getHeight()-70;var i=this.leftPointerStartPos.x,s=this.leftPointerStartPos.y,n=28/Math.sqrt(Math.pow(t.x-i,2)+Math.pow(t.y-s,2)),o=Math.round((t.y-s)*n+s),a=Math.round((t.x-i)*n+i);a-this.leftPointerStartPos.x&&this.leftPointerStartPos.x,o-this.leftPointerStartPos.y&&this.leftPointerStartPos.y;return this.ship.targetVel.copyFrom(this.leftVector),this.ship.targetVel.multiplyEq(.15),this.ship.update(),this.ship.pos.y<8?this.ship.pos.y=8:this.ship.pos.y>e.getHeight()-e.ship.canvas.offsetHeight&&(this.ship.pos.y=e.getHeight()-e.ship.canvas.offsetHeight),n<1?{y:o,x:a}:t},this.loadSettings=function(){var e=this;for(var i in window.devicePixelRatio||(window.devicePixelRatio=Number((window.screen.deviceXDPI/window.screen.logicalXDPI).toFixed(1))),window.onorientationchange=window.onresize=function(){$("#init .wrapper").css({marginTop:-Math.round($("#init .wrapper").height()/2-20)}),e.resize()},this.keycodes)this.keystatus[t[i]]=!1;this.canvas=document.getElementById("the-responsive-game"),this.context=this.canvas.getContext("2d"),this.setPixelRatio(),this.half.width=this.getWidth()/2,this.half.height=this.getHeight()/2,document.getElementById("btn-init").addEventListener("click",(function(){$("#init").hide(),e.start(),e.resize()})),document.getElementById("btn-reinit").addEventListener("click",(function(){$("#gameover").hide(),e.restart(),e.resize()})),document.getElementById("btn-placar").addEventListener("click",(function(){e.getHighScore()})),document.getElementById("btn-placar-2").addEventListener("click",(function(){e.getHighScore()})),document.getElementById("score-close").addEventListener("click",(function(){$("#highscore").removeClass("show")}));var s=document.getElementById("game-container");s.appendChild(this.stars.starMinCanvas),s.appendChild(this.stars.starMaxCanvas),s.appendChild(this.ship.canvas),this.pointers=[],this.leftPointerStartPos.x=70,this.leftPointerStartPos.y=this.getHeight()-70,this.ship.main=this,this.canvas.addEventListener("pointerdown",this.mousedown,!1),this.canvas.addEventListener("pointermove",this.mousemove,!1),this.canvas.addEventListener("pointerup",this.mouseup,!1),this.canvas.addEventListener("pointerout",this.mouseup,!1),document.addEventListener("keydown",this.onkeydown,!1),document.addEventListener("keyup",this.onkeyup,!1)},this.getHighScore=function(){$.ajax({type:"GET",url:"ranking",dataType:"json"}).done((function(t){e.showScore(t)}))},this.showScore=function(t){$("#highscore").addClass("show"),$("#highscore .top10").html(""),$.each(t.users,(function(t){$("#highscore .top10").append('<li><span class="score-counter">'+(t+1)+'<i>&ordm;</i></span><span class="score-user-picture"><img src="'+this.go_score_user_image+'" alt=""></span><span class="score-name">'+this.go_score_value+'</span><span class="score-val">'+this.go_score_user_mail+"</span></li>")}))},this.onkeydown=function(t){var i=t.keyCode?t.keyCode:t.charCode;38!=i&&40!=i||t.preventDefault(),e.keycodes[i]&&(t.preventDefault(),e.keystatus[e.keycodes[i]]=!0)},this.onkeyup=function(t){var i=t.keyCode?t.keyCode:t.charCode;e.keycodes[i]&&(t.preventDefault(),e.keystatus[e.keycodes[i]]=!1)},this.hideAddressBar=function(){window.location.hash||(this.getHeight()<window.outerHeight&&(document.body.style.height=window.outerHeight+50+"px"),setTimeout((function(){window.scrollTo(0,1)}),100))},this.getWidth=function(){return document.documentElement.clientWidth},this.getHeight=function(){return document.documentElement.clientHeight},this.resize=function(){this.hideAddressBar(),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.leftPointerStartPos.x=70,this.leftPointerStartPos.y=this.getHeight()-70,this.setPixelRatio(),this.stars.resize(),window.scrollTo(0,0)},this.loadAssets=function(t,e){var i=this,s=new Image;return s.onload=function(){e&&(i.callback=e,i.callback(this))},s.src=t,this},this.start=function(){setTimeout((function(){var t=document.getElementById("spaceship");t.setAttribute("data-status","actived");var i="translate3d(130px, "+(e.getHeight()/2-20)+"px, 0px) rotate(0deg)";t.style.webkitTransform=t.style.MozTransform=t.style.OTransform=t.style.transform=i}),1600),console.log("start"),$("#game-score").show(),$(".game-life").show(),this.leftPointerStartPos.x=70,this.leftPointerStartPos.y=this.getHeight()-70,this.update()},this.intro=function(){},this.collides=function(t,e,i,s,n,o,a,h){return!(i<=n||t>a||s<=o||e>h)},this.boxCollides=function(t,e,i,s){return this.collides(t.x,t.y,t.x+e.width,t.y+e.height,i.x,i.y,i.x+s.width,i.y+s.height)},this.checkCollisions=function(){for(var t=0;t<this.asteroids.length;t++){for(var i={x:this.asteroids[t].x,y:this.asteroids[t].y},s={width:this.asteroids[t].scale,height:this.asteroids[t].scale},n=0;n<this.ship.bullets.length;n++){var o={x:this.ship.bullets[n].x,y:this.ship.bullets[n].y},a={width:this.ship.bullets[n].width,height:this.ship.bullets[n].height};if(this.boxCollides(i,s,o,a)){this.asteroids.splice(t,1),t--,this.ship.bullets.splice(n,1),e.mute||createjs.Sound.play("explosion"),this.score.getPoints(100*s.width/120);break}}var h={pos:{x:120,y:this.ship.pos.y},size:{width:10,height:10}};this.boxCollides(i,s,h.pos,h.size)&&(this.asteroids.splice(t,1),t--,this.life--,this.life||this.gameover(),$(".game-life .lifes i:first").remove())}},this.update=function(){var t=this;new Date(this.endTime-Date.now());this.life=$(".game-life .lifes").children().length;var e=(Date.now()-this.lastTime)/1e3;this.gameTime+=e,t.context.clearRect(0,0,t.canvas.width,t.canvas.height),this.stars.move(this.context,this.ship.pos.x,this.ship.pos.y),Math.random()<1-Math.pow(.993,this.gameTime)&&this.asteroids.push(new Asteroid(t,t.getWidth(),Math.random()*t.getHeight()-60)),t.keystatus.space&&!t.isGameOver&&setTimeout((function(){t.ship.fire()}),200),t.keystatus.up&&!t.isGameOver&&(t.ship.pos.y-=6),t.keystatus.down&&!t.isGameOver&&(t.ship.pos.y+=6),(t.keystatus.space||t.keystatus.up||t.keystatus.down)&&(t.isGameOver||(t.ship.pos.y<8?t.ship.pos.y=8:t.ship.pos.y>t.getHeight()-t.ship.canvas.offsetHeight&&(t.ship.pos.y=t.getHeight()-t.ship.canvas.offsetHeight),t.ship.update())),this.asteroids.forEach((function(t){t.update(),t.draw()})),this.asteroids=this.asteroids.filter((function(t){return t.active})),this.isGameOver||this.checkCollisions(),this.ship.draw(),this.isGameOver||t.createFireButton(),t.pointers.length||this.isGameOver||t.createJoystickButton(t.leftPointerStartPos.x,t.leftPointerStartPos.y),t.pointers=t.pointers.slice(0,2);for(var i=0;i<t.pointers.length;i++){var s=t.pointers[i];if(s.identifier!=t.leftPointerID&&1==t.pointers.length&&t.createJoystickButton(t.leftPointerStartPos.x,t.leftPointerStartPos.y),s.identifier==t.leftPointerID){var n={x:s.clientX,y:s.clientY},o=t.setControlPos(n);this.isGameOver||t.createJoystickButton(o.x,o.y)}}this.lastTime=Date.now(),window.requestAnimationFrame?window.requestAnimationFrame((function(){t.update()})):window.requestAnimationFrame?window.webkitRequestAnimationFrame((function(){t.update()})):window.requestAnimationFrame?window.mozRequestAnimationFrame((function(){t.update()})):window.requestAnimationFrame?window.oRequestAnimationFrame((function(){t.update()})):window.requestAnimationFrame?window.msRequestAnimationFrame((function(){t.update()})):window.setTimeout((function(){t.update()}),1e3/60)},this.init=function(t){var e=this;navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate,$("#game-container").html($("#game-tmpl").html()),t||($("#init").show(),setTimeout((function(){e.mute||createjs.Sound.play("musicfx")}),200)),e.loadSettings()},this.mouseup=function(t){e.createFireButton(),e.pointers=t.getPointerList(),e.pointers=e.pointers.slice(0,2),0==e.pointers.length&&(e.leftPointerID=-1,t.pointerType==PointerTypes.pointer&&e.leftVector.reset(0,0))},this.mousemove=function(t){t.preventDefault(),e.pointers=t.getPointerList(),e.pointers=e.pointers.slice(0,2);for(var i=0;i<e.pointers.length;i++){var s=e.pointers[i];if(e.leftPointerID==s.identifier){e.leftPointerPos.reset(s.clientX,s.clientY),e.leftVector.copyFrom(e.leftPointerPos),e.leftVector.minusEq(e.leftPointerStartPos);break}}},this.mousedown=function(t){e.pointers=t.getPointerList(),e.pointers=e.pointers.slice(0,2);for(var i=0;i<e.pointers.length;i++){var s=e.pointers[i];e.leftPointerID<0&&s.clientX<e.half.width?(e.leftPointerID=s.identifier,e.leftPointerStartPos.reset(s.clientX,s.clientY),e.leftPointerPos.copyFrom(e.leftPointerStartPos),e.leftVector.reset(0,0)):(e.isGameOver||e.ship.fire(),console.log("ship.fire"))}},this.loadSounds=function(){createjs.Sound.initializeDefaultPlugins()&&(createjs.Sound.alternateExtensions=["mp3"],createjs.Sound.registerManifest(this.manifest,this.audioPath),createjs.Sound.addEventListener("fileload",(function(){e.sounds=!0,e.load()})))},this.load=function(){this.sounds?this.loadAssets("assets/img/gameui/btn-fire.png",(function(t){this.firebtn=t,this.loadAssets("assets/img/gameui/btn-joystick.png",(function(t){this.joystickbtn=t,this.loadAssets("assets/img/gameui/bkg-asteroid.png",(function(t){this.spriteAsteroid=t,this.init()}))}))})):this.loadSounds()},this.restart=function(){this.fps=60,this.canvas,this.context,this.pointers=[],this.joystick=1,this.devicePixelRatio=1,this.backingStoreRatio=1,this.ratio=1,this.half={},this.leftPointerID=-1,this.leftPointerPos=new Vector2(0,0),this.leftPointerStartPos=new Vector2(0,0),this.leftVector=new Vector2(0,0),this.stars=new Starfield,this.score=new Score(0),this.asteroids=[],this.lastTime=Date.now(),this.gameTime=1e-4,this.fase=1,this.endTime=Date.now()+3e4,this.isGameOver=!1,this.life=3,this.stats=new Stats,this.self=this;for(var t=0;t<3;t++)$(".game-life .lifes").append('<i class="ui-icon icon-heart"></i>');this.init(!0),$("#spaceship").show(),$("#game-score").show(),$(".game-life").show()},this.gameover=function(){this.isGameOver=!0,this.ship.pos.x=-300,this.ship.pos.y=-300,this.isGameOver=!0,$("#gameover .wrapper").css({marginTop:-Math.round($("#gameover .wrapper").height()/2+60)}),$("#gameover").show(),$("#spaceship").hide(),$("#game-score").hide(),$(".game-life").hide(),$("#ponto-placar-final").text(this.score.getScore()+" pontos"),$.ajax({type:"POST",data:{kng:e.lambda(),csrftk:$("#csrftk").val()},url:"ranking",dataType:"json"}).done((function(t){console.log(t)}))},this.lambda=function(){for(var t=String(e.score.getScore()).toString().length,i=parseInt(e.score.getScore()).toString(),s=["abcdefghijklmnopqrstuvwxyz"].split(""),n=[],o=0;o<t;o++){for(var a=String(parseInt($("div.py").data().py/i[o])).toString(),h=[],r=0;r<a.length;r++)h.push(s[a[r]]);n.push(h.join(""))}return n.join("%dx%")}},Score=function(){var t=this.points=0,e=this.score=0,i=this.time=0,s=this.fntime=0,n=this.lim=[],o=this.n=1;this.getRandomPoints=function(e){var i=this;return t+=e,n.push(1),$("#game-score span.add").text($("#game-score span.add").text()+"+"+t),n.length>=3&&this.setPoints(),clearTimeout(s),s=setTimeout((function(){i.setPoints()}),600),t},this.setPoints=function(){$("#game-score span.add").addClass("more"),clearTimeout(i),i=setTimeout((function(){$("#game-score span.add.more").remove(),t=0,n=[],$("#game-score span.score").text(e),Math.floor(e/(1e4*o))&&$(".game-life .lifes").children().length<5&&($(".game-life .lifes").append('<i class="ui-icon icon-heart new"></i>'),++o>10&&(o=10))}),100)},this.getPoints=function(t){$("#game-score span.add").length||$("#game-score").append('<span class="add"></span>'),$("#game-score span.add").removeClass("more"),e=this.score=this.score+this.getRandomPoints(Math.round(t))},this.getScore=function(){return parseInt($("#game-score span.score").text())}},SpaceShip=function(){var t=this.pos=new Vector2(0,0),e=(this.angle=0,this.vel=new Vector2(0,0)),i=this.targetVel=new Vector2(0,0),s=new Vector2(0,0),n=this.canvas=document.createElement("canvas"),o=(this.main,n.width/2),a=n.height/2;document.documentElement.clientWidth,document.documentElement.clientHeight;n.width=40,n.height=40,n.id="spaceship";var h,r=n.getContext("2d");this.context=r,this.loadSpaceship=((h=new Image).onload=function(){r.drawImage(this,0,0,h.width,h.height,0,0,40,30)},void(h.src="assets/img/gameui/spaceship.png"));this.bullets=[];this.move=function(e,i){if(n.setAttribute("class","actived"),"actived"==n.getAttribute("data-status")){var s="translate3d(130px, "+t.y+"px, 0px) rotate("+this.angle+"deg)";n.style.webkitTransform=n.style.MozTransform=n.style.OTransform=n.style.transform=s}},this.draw=function(){this.bullets.forEach((function(t){t.update(),t.draw()})),this.bullets=this.bullets.filter((function(t){return t.active}))},this.update=function(){i.isMagGreaterThan(6)&&(i.normalise(),i.multiplyEq(6)),i.equals(e)||(s.copyFrom(i),s.minusEq(e),s.isMagGreaterThan(1e-4)&&s.multiplyEq(1),e.plusEq(s)),t.plusEq(e),e.isMagGreaterThan(0)&&(this.angle=0),this.move(t.x,t.y)},this.fire=function(){createjs.Sound.play("shot"),this.bullets.push(new Bullet(this.main,155,this.pos.y+29))},this.setPixelRatio=function(){var t=window.devicePixelRatio||1,e=r.webkitBackingStorePixelRatio||r.mozBackingStorePixelRatio||r.msBackingStorePixelRatio||r.oBackingStorePixelRatio||r.backingStorePixelRatio||1;1===t&&(t=1);var i=t/e;if(t!==e){var s=n.width,o=n.height;n.width=s*i,n.height=o*i,n.style.width=s+"px",n.style.height=o+"px",r.scale(i,i)}}()},Starfield=function(){var t=["assets/img/gameui/bkg-stars-max.png","assets/img/gameui/bkg-stars-mid.png","assets/img/gameui/bkg-stars-min.png"],e=this.starMinCanvas=document.createElement("canvas"),i=this.starMaxCanvas=document.createElement("canvas"),s=this.starMidCanvas=document.createElement("canvas");e.width=s.width=i.width=document.documentElement.clientWidth,e.height=s.width=i.height=document.documentElement.clientHeight,e.id="starMinCanvas",i.id="starMaxCanvas",s.id="starMidCanvas";var n,o,a,h=e.getContext("2d"),r=i.getContext("2d"),c=s.getContext("2d");this.starMinContext=h,this.starMaxContext=r,this.starMidContext=c;var l=0,d=0,u=0;this.move=function(t,n,o){var a=document.documentElement.clientWidth;document.documentElement.clientHeight;(l+=6.5)>a&&(l=0),(d+=.2)>a&&(d=0),(u+=.5)>a&&(u=0),t.drawImage(s,-u,0),t.drawImage(s,a-u,0),t.drawImage(e,-d,0),t.drawImage(e,a-d,0),t.drawImage(i,-l,0),t.drawImage(i,a-l,0)},this.init=function(){this.resize()},this.resize=function(){var t=document.documentElement.clientWidth,l=document.documentElement.clientHeight;e.width=s.width=i.width=t,e.height=s.height=i.height=l,a&&(r.fillStyle=r.createPattern(a,"repeat"),r.fillRect(0,0,t,l),c.fillStyle=c.createPattern(o,"repeat"),c.fillRect(0,0,t,l),h.fillStyle=h.createPattern(n,"repeat"),h.fillRect(0,0,t,l))},this.loadStarfield=function(){for(var e=this,i=0;i<t.length;i++){var s=new Image;s.onload=function(){t.pop(),String(this.src).toString().indexOf("max")>-1?a=this:String(this.src).toString().indexOf("mid")>-1?o=this:n=this,0===t.length&&e.init()},s.src=t[i]}},this.loadStarfield()};!function(){var t=new GameTeste;document.addEventListener("DOMContentLoaded",(function(){t.load()}))}();